#!/usr/bin/env bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
if [[ "$CIRCLECI" == "true" ]]; then
  source $DIR/env_circle
else
  source $DIR/env_drone
fi

ENV=testing
if [[ $CI_TAG =~ ^v([0-9]+.[0-9]+.[0-9]+)$ ]]; then
  ENV=production
elif [[ $CI_BRANCH =~ ^release/[0-9]+.[0-9]+$ ]]; then
  ENV=staging
else
  ENV=testing
fi

APT_REPO="${APT_REPO:-internal.apt.fresh8.tech}"
ARCH=$(dpkg --print-architecture)

LATEST=$(ls -t1 f8-$NAME*.deb 2>/dev/null | head -n 1)

if [[ -z $LATEST ]]; then
  echo No .deb files found for $NAME >&2
  exit 1
fi

if [[ "$DRONE" == "true" ]]; then
  curl -X POST -F file=@$LATEST http://$APT_REPO/api/files/$(basename $LATEST .deb)
  curl -X POST http://$APT_REPO/api/repos/$ENV/file/$(basename $LATEST .deb)
  curl -X PUT -H 'Content-Type: application/json' --data '{}' http://$APT_REPO/api/publish/$ENV/trusty
  curl -X POST -F "pkg=$(basename $LATEST .deb)" -F "env=$ENV" http://$APT_REPO/notify
else
  REPO_PATH=/home/apt/.aptly/upload/$LATEST
  scp $LATEST $CI_USER@$APT_REPO:$REPO_PATH

  ssh $CI_USER@$APT_REPO 'chmod 0775 '$REPO_PATH'; env='$ENV' deb_filename='$LATEST' aptly-update'
fi
