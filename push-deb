#!/usr/bin/env bash
ENV=testing
if [[ $CI_BRANCH =~ ^v[0-9]+.[0-9]+.[0-9]+$ ]]; then
  ENV=production
elif [[ $CI_BRANCH =~ ^release/[0-9]+.[0-9]+$ ]]; then
  ENV=staging
else
  ENV=testing
fi

APT_REPO="${APT_REPO:-10.240.0.58:8080}"
ARCH=$(dpkg --print-architecture)

LATEST=$(ls -t1 f8-$NAME*.deb 2>/dev/null | head -n 1)

if [[ -z $LATEST ]]; then
  echo No .deb files found for $NAME >&2
  exit 1
fi

curl -v -X POST -F file=@$LATEST http://$APT_REPO/api/files/$LATEST
curl -v -X POST http://$APT_REPO/api/files/$LATEST
curl -v -X POST http://$APT_REPO/api/repos/$ENV/file/$LATEST
